name: XGBoost Model Training and Deployment

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  train_and_deploy:
    name: "Train and Deploy XGBoost Model"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: sixth-utility-449722-p8

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          pip install xgboost numpy scikit-learn google-cloud-storage

      - name: Train XGBoost Model
        run: |
          python train_xgboost.py  # This should now properly save and upload the model

      - name: Verify Model Upload
        run: |
          gsutil ls gs://housing-data-bucket-poc/model_registry/model.bst || exit 1

      - name: Upload Model to Vertex AI Model Registry
        run: |
          gcloud ai models upload \
            --region=us-central1 \
            --display-name=house-price-xgb-model \
            --container-image-uri=us-docker.pkg.dev/vertex-ai/prediction/xgboost-cpu.1-3:latest \
            --artifact-uri=gs://housing-data-bucket-poc/model_registry/model.bst
